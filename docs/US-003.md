# US-003: Handle Missing Product Mappings

**Priority**: MANDATORY (P0)
**Epic**: Core Data Enrichment Engine
**Complexity**: S
**Dependencies**: US-002

## User Story

As an API consumer, I want trades with unmapped product IDs to still be included in the output with a placeholder product name so that I don't lose trade data due to missing reference information.

## Acceptance Criteria

1. When a productId is not found in the product reference data, set productName to "Missing Product Name"
2. Log a warning message including the missing productId and the trade row data
3. The trade row is included in the output (not discarded)
4. Warning log includes timestamp and is aggregated if same productId appears multiple times
5. A count of missing mappings can be retrieved for reporting

## Technical Notes

- Use structured logging to enable querying for missing productIds
- Consider maintaining a set of logged missing IDs to avoid duplicate warnings

---

## Implementation Plan

### Summary

US-003 was 90% implemented in prior work. The only gap was **AC2**: logging should include trade row data, not just the productId.

### Changes Made

1. **TradeEnrichmentService.cs**:
   - Updated `LogMissingProductIfNeeded` method to accept trade data parameters (date, currency, price)
   - Updated `LogMissingProduct` method to include trade context in the log message
   - Updated both call sites in `EnrichTrade` and `EnrichTrades` methods

2. **TradeEnrichmentServiceTests.cs**:
   - Enhanced `EnrichTrade_WithMissingProduct_ShouldLogWarning` test to verify all trade data appears in the log

### Log Output

**Before**:
```
[Warning] Product ID 999 not found in product reference data, using placeholder
```

**After**:
```
[Warning] Product ID 999 not found in product reference data. Trade: Date=20250605, Currency=USD, Price=123.45. Using placeholder.
```

---

## Progress

- [x] AC1: Set productName to "Missing Product Name" when not found
- [x] AC2: Log warning with productId and trade row data
- [x] AC3: Trade row included in output (not discarded)
- [x] AC4: Timestamp included, warnings aggregated (each productId logged once)
- [x] AC5: Count of missing mappings available via EnrichmentSummary

**Status**: Complete
**Tests**: 75 passed, 0 failed
