# US-009: CSV Enrichment Endpoint

**Priority**: MANDATORY (P0)
**Epic**: API Design & Implementation
**Complexity**: M
**Dependencies**: US-001, US-002, US-003, US-004, US-005, US-006, US-007

## User Story

As an API consumer, I want to POST trade data in CSV format to an enrichment endpoint so that I can receive enriched trade data.

## Acceptance Criteria

1. Endpoint is available at POST /api/v1/enrich
2. Accepts CSV data in request body with Content-Type: text/csv
3. Returns enriched CSV data in response body
4. Response Content-Type is text/csv
5. Returns HTTP 200 for successful processing (even if some rows discarded)
6. Returns HTTP 400 for malformed requests (invalid CSV structure, empty body)
7. Returns HTTP 500 for server errors with appropriate error message
8. Request size limit is configurable (default: reasonable for large files, e.g., 100MB)

## Technical Notes

- Use ASP.NET Core minimal API or controller-based approach
- Configure request size limits in middleware
- Consider using streaming for large requests

---

## Implementation Plan

See `/Users/anton/.claude/plans/rippling-stargazing-bonbon.md` for detailed implementation plan.

---

## Implementation Summary

### Files Created

**Api Layer:**
- `src/Api/Controllers/EnrichController.cs` - POST /api/v1/enrich endpoint
- `src/Api/Formatters/CsvInputFormatter.cs` - Parses text/csv to TradeInputDto
- `src/Api/Formatters/CsvOutputFormatter.cs` - Writes EnrichedTradeOutputDto as CSV
- `src/Api/Extensions/EnrichmentHeadersExtensions.cs` - X-Enrichment-* response headers

**Configuration:**
- `src/Application/Configuration/EnrichmentEndpointOptions.cs` - Max request size, timeout config
- `src/Infrastructure/Configuration/EnrichmentEndpointOptionsValidator.cs` - Options validation

**Tests (75 tests):**
- `tests/Api.Tests/Controllers/EnrichControllerTests.cs` - 16 unit tests
- `tests/Api.Tests/Formatters/CsvInputFormatterTests.cs` - 15 unit tests
- `tests/Api.Tests/Formatters/CsvOutputFormatterTests.cs` - 16 unit tests
- `tests/Api.Tests/Integration/EnrichmentEndpointIntegrationTests.cs` - 13 integration tests
- `tests/Api.Tests/Helpers/TestDataBuilder.cs` - Test data factory (15 tests)

### Acceptance Criteria Verification

1. Endpoint available at POST /api/v1/enrich
2. Accepts CSV data with Content-Type: text/csv
3. Returns enriched CSV data in response body
4. Response Content-Type is text/csv
5. Returns HTTP 200 for successful processing (even if some rows discarded)
6. Returns HTTP 400 for malformed requests (invalid CSV structure, empty body)
7. Returns HTTP 500 for server errors with appropriate error message
8. Request size limit configurable (default: 100MB) via EnrichmentEndpointOptions

---

## Progress

- **2026-01-11**: Implementation complete, all 370 tests passing
